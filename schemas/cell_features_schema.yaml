id: https://brain-connects.org/ic3-morphology-features-schema
name: cell_features_schema
description: Schema for extensible cell feature measurements across cells.
prefixes:
  linkml: https://w3id.org/linkml/
  schema: http://schema.org/
  skos: http://www.w3.org/2004/02/skos/core#
  cc: https://brain-connects.org/cc/
default_prefix: cc
default_range: string
imports:
  - base_schema
  - core_schema
  - zarr_schema

classes:
  CellFeatureSet:
    description: A defined set of cell features with their descriptions and metadata.
    slots:
      - id
      - description
      - feature_definition_ids
      - extraction_method
    slot_usage:
      id:
        range: string
        required: true
        description: Human-readable short name for this feature set (e.g., 'AllenFeatureSet1', 'NeuroMorpho', 'AuthorYearSet').
      description:
        range: string
        description: Longer human description of what this feature set measures and where it came from.
      feature_definition_ids:
        multivalued: true
        range: CellFeatureDefinition
        description: Individual feature definitions within this set.
      extraction_method:
        range: string
        description: Method used to extract these features (e.g., 'L-Measure', 'NeuroMorpho', 'custom').

  CellFeatureDefinition:
    description: Definition of a single feature with metadata.
    slots:
      - id
      - description
      - unit
      - data_type
      - range_min
      - range_max
    slot_usage:
      description:
        range: string
        description: Detailed description of what this feature measures.
      unit:
        range: string
        description: Unit of measurement (e.g., 'micrometers', 'degrees', 'count').
      data_type:
        range: string
        pattern: '^([<>|=])[tbiufcmMOSUV]\d+$'
        description: "Data type as NumPy typestr (byteorder + code + bytes), e.g., '<i2', '<f4', '|u1'."
      range_min:
        range: float
        description: Expected minimum value for this feature.
      range_max:
        range: float
        description: Expected maximum value for this feature.

  CellFeatureMatrix:
    description: |- 
       Pointer to a Wide form measurement matrix of feature values for a particular FeatureSet in Parquet format.
       One column (cell_index_column) should be the DataItemId and the rest of columns of this matrix should be named according to the CellFeatureDefinition in the CellFeatureSet.
    mixins:
      - ProjectScoped
    slots:
      - id
      - feature_set_id
      - parquet_path
      - cell_index_column
    slot_usage:
      feature_set_id:
        range: CellFeatureSet
        required: true
        description: Reference to the CellFeatureSet that defines the features in this matrix.
      parquet_path:
        range: ParquetDataset
        description: Path to parquet dataset containing wide-form data. Columns should be named the id of a CellFeatureDefinition in the CellFeatureSet.
      cell_index_column:
        range: string
        description: Column of the parquet which corresponds to the DataItem

  CellFeatureMeasurement:
    description: "Long-form measurement row: one (cell, feature) value with strict dtype."
    slots:
      - id
      - dataitem_id
      - feature_id
      - dtype
      - value_float
      - value_int
      - value_bool
      - value_string
      - value_bytes
      - value_datetime
    slot_usage:
      dataitem_id:
        range: DataItem
        required: true
      feature_id:
        range: CellFeatureDefinition
        required: true
      feature_set_id:
        range: CellFeatureSet
        description: Denormalized reference to the feature set (helps partitioning and joins).
      dtype:
        range: string
        pattern: '^([<>|=])[tbiufcmMOSUV]\\d+$'
        description: "NumPy typestr of the stored value (see arrays.interface)."
      value_float:
        range: float
      value_int:
        range: integer
      value_bool:
        range: boolean
      value_string:
        range: string
      value_bytes:
        range: string
        description: Base64-encoded bytes when binary values are needed.
      value_datetime:
        range: datetime
        description: ISO 8601 timestamp when dtype corresponds to datetime.
      unit:
        range: Unit
        description: Unit of measurement for the values in this matrix.

slots:
  feature_set_id:
    description: A set of features that are a coherent feature set. 
  feature_definition_ids:
    description: Individual feature definitions within a feature set.
  feature_name:
    description: Name of a morphology feature.
  feature_id:
    description: Reference to a feature definition used for a measurement.
    range: CellFeatureDefinition
  data_type:
    description: "NumPy typestr (byteorder + code + bytes), e.g., '<i2', '<f4', '|u1'."
    pattern: '^([<>|=])[tbiufcmMOSUV]\\d+$'
  feature_index:
    description: Ordered list of features indexing a matrix.
  feature_values:
    description: Zarr dataset containing per-feature arrays for matrix values.
  backing_store:
    description: Parquet dataset containing long-form (cell, feature, value) records.
  dtype:
    description: NumPy typestr (see https://numpy.org/doc/stable/reference/arrays.interface.html).
  extraction_method:
    description: Method used to extract morphology features.
  range_min:
    description: Expected minimum value for this feature.
    range: float
  range_max:
    description: Expected maximum value for this feature.
    range: float
  value_float:
    description: Floating point value for a (cell, feature) measurement.
    range: float
  value_int:
    description: Integer value for a (cell, feature) measurement.
    range: integer
  value_bool:
    description: Boolean value for a (cell, feature) measurement.
    range: boolean
  value_string:
    description: String value for a (cell, feature) measurement.
    range: string
  value_bytes:
    description: Base64-encoded bytes value for a (cell, feature) measurement.
    range: string
  value_datetime:
    description: Datetime value (ISO 8601) for a (cell, feature) measurement.
    range: datetime
  parquet_path:
    description: "path to a parquet file where the features are stored. i.e. s3://my_bucket/my_path. file:// for files, gs:// for google cloud storage, https:// for http"
    pattern: ^(s3://|gs://|https?://|file://).+ 
    range: string
  cell_index_column:
    description: "name of column in parquet file that contains the DataItem identifier"
    range: string